#!/usr/bin/env bash

set -euo pipefail

DO_BASE_DIR="$HOME/code"

DO_REPO_URL="https://git.savannah.gnu.org/git/emacs.git"

DO_REPO_DIRECTORY="emacs"

DO_REPO_BRANCH="feature/native-comp"

DO_APP_LOCATION="$HOME/Applications/Emacs.app"

DO_BREW_PACKAGES=(
  autoconf
  cairo
  cmake
  gcc
  gnupg
  gnutls
  # The macOS build uses the Cocoa image library
  # imagemagick
  jansson
  libgccjit
  librsvg
  libvterm
  libxml2
  pkg-config
  texinfo
)

DO_BREW_CASKS=(
  mactex
)

DO_LIBS=(
  $(xcode-select -p)/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr
  gcc
  libgccjit
  giflib
  gnutls
  jansson
  jpeg
  libtiff
  libxml2
  # Required by gnutls
  nettle
  libtasn1
  p11-kit
)

DO_CONFIGURE_OPTS=(
  --config-cache
  --without-pop
  --with-ns
  --disable-ns-self-contained
  --with-cairo
  # --with-imagemagick
  --with-modules
  --with-nativecomp
  --with-xml2
  --with-gnutls
  --with-json
  --program-transform-name='s/^ctags$/ctags.emacs/'
)

# native-comp optimization
export BYTE_COMPILE_EXTRA_FLAGS="--eval '(setq comp-speed 2)'"
# Ensure we can find the Homebrew installed version of libgccjit
export LIBRARY_PATH="$(brew --prefix libgccjit)/lib/gcc/10/"

. build-utils

# Install Emacs from the build directory
do_install() {
  local target="${1:-$DO_REPO_DIRECTORY}"
  do_heading "Installing $target..."

  # Ensure the directory to which we will install Emacs exists and has the correct
  # permissions set.
  local libexec=/usr/local/libexec/emacs
  if [ ! -d $libexec ]; then
    sudo mkdir -p $libexec
    chown $USER $libexec
  fi

  pushd "$DO_BASE_DIR/$target"

  # Even though we move the binary ourselves, we still need to install to get
  # the Emacs Lisp and C source files in the right place.
  make -j $DO_CORES install
  rm -rf "$DO_APP_LOCATION"

  # Move Emacs.app to its final location.
  mv "nextstep/Emacs.app" "$DO_APP_LOCATION"

  # Copy native compiled ELisp into Emacs.app, which is where it is expected by
  # the configure and compilation process.
  cp -R "native-lisp" "$DO_APP_LOCATION/Contents/"

  # Add annotations to Emacs.app to request access to special directories.
  plist="$DO_APP_LOCATION/Contents/Info.plist"
  defaults write "$plist" NSDesktopFolderUsageDescription -string "Emacs requires permission to access the Desktop folder."
  defaults write "$plist" NSDocumentsFolderUsageDescription -string "Emacs requires permission to access the Documents folder."
  defaults write "$plist" NSDownloadsFolderUsageDescription -string "Emacs requires permission to access the Downloads folder."
  defaults write "$plist" NSRemovableVolumesUsageDescription -string "Emacs requires permission to access files on Removable Volumes."
  # This will convert the Info.plist from xml representation to the binary form.
  # Now we convert it back.
  plutil -convert xml1 "$plist"

  echo "Emacs is installed. See README.org for notes on fixing the menu."

  popd
}

do_all

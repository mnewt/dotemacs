#!/usr/bin/env bash

set -euo pipefail

. build-utils

DO_BASE_DIR="$HOME/code/"
DO_REPO_URL="git://gcc.gnu.org/git/gcc.git"
DO_REPO_DIRECTORY="gcc"
DO_REPO_BRANCH="master"
DO_CONFIGURE_OPTS=(
	# Xcode 10 dropped 32-bit support
	--disable-multilib
	--prefix=/usr/local/gcc
	--enable-languages=c,c++,objc,obj-c++,fortran,jit
	--enable-host-shared
	--with-native-system-header-dir=/usr/include
	--with-sysroot=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk
)
DO_DIRS=(
	$(xcode-select -p)/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include
)

# WIP
# export CFLAGS+=" -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk"
# export CCFLAGS+=" -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk"
# export CXXFLAGS+=" -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk"
# export CPPFLAGS+=" -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk"

do_build() {
	heading "Building $DO_REPO_DIRECTORY..."

	pushd "$DO_BASE_DIR/$DO_REPO_DIRECTORY"

	# make clean
	# ./autogen.sh
	./configure "${DO_CONFIGURE_OPTS[@]}"
	make -j $DO_CORES

	popd
}

do_fetch
./contrib/download_prerequisites
do_vars
do_build

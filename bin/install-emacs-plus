#!/usr/bin/env bash
# Build or rebuild an Emacs-Plus installation
# https://github.com/d12frosted/homebrew-emacs-plus

set -euo pipefail

# Prompt user to confirm
prompt_confirm() {
  local confirm
  while true; do
    read -p "$* [y/N]: " confirm
    case $confirm in
      [yY]*) return 0 ;;
      [nN]*) return 1 ;;
    esac
  done
}

emacs=emacs-plus@29
destination="$HOME/Applications/Emacs.app"

brew install gcc libgccjit || brew upgrade gcc libgccjit
brew tap d12frosted/emacs-plus
brew uninstall $emacs || true
brew install $emacs --build-from-source --with-native-comp
# These are PRs that I don't think will be accepted.
# brew install d12frosted/emacs-plus/$emacs --with-native-comp --with-c-source --without-compressed-elisp --build-from-source
# If it's not a symlink, it's best that this error out and we can figure it out
# manually.
rm "$destination" || true
ln -s "$(brew --prefix $emacs)/Emacs.app" "$destination"
prompt_confirm "Remove $HOME/.emacs.d/{eln-cache,straight}?" &&
  rm -rf $HOME/.emacs.d/{eln-cache,straight}

echo "Restart Emacs for changes to take effect"
